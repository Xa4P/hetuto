---
title: "Tutorial Decision tree"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
description: >
  Learn how to use a decision tree to estimate the cost effectiveness 
  of a new treatment strategy for aneurysm versus usual care.
---
```{r setup, include = FALSE}
require(learnr, quietly = TRUE)
require(knitr, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(shiny, quietly = TRUE)
require(dplyr, quietly = TRUE)
require(DiagrammeR, quietly = TRUE)
require(magrittr, quietly = TRUE)

diagram_1 <- "
digraph {

      # graph attributes
      graph [overlap = true, 
             rankdir = LR]

      # edge attributes
      edge [color = gray]

      # node statements
      node [shape = box,
      fontname = Helvetica,
      color = gray,
      label = '']
      A [label = Detection] 
      
      # node statements
      node [shape = oval,
      fontname = Helvetica,
      color = gray]
      B [label = 'Watchful waiting'] 
      C [label = 'Aneurysm treatment'] 
      
      # node attributes
      node [shape = circle, 
      width = 0.5,
      color = black,
      label = ' ']
      D; E
      
      # node attributes
      node [shape = circle, 
      width = 0.5,
      color = black,
      label = ' ']
      F; G; H; I 
      
       # node statements
      node [shape = box,
      fontname = Helvetica,
      color = gray]
      
      J [label = A]
      K [label = B]
      L [label = C]
      M [label = D]
      N [label = E]
      O [label = F]
      P [label = G]
      Q [label = H]
      R [label = I]
      S [label = J]
      T [label = K]
      
      1 [label = 'effect and costs pathway A']
      2 [label = 'effect and costs pathway B']
      3 [label = 'effect and costs pathway C']
      4 [label = 'effect and costs pathway D']
      5 [label = 'effect and costs pathway E']
      6 [label = 'effect and costs pathway F']
      7 [label = 'effect and costs pathway G']
      8 [label = 'effect and costs pathway H']
      9 [label = 'effect and costs pathway I']
      10 [label = 'effect and costs pathway J']
      11 [label = 'effect and costs pathway K']

      # edge statements
      A -> B [arrowhead = none]
      A -> C [arrowhead = none]
      B -> D 
      C -> E
      D -> F [label = 'Aneurysm rupture'] 
      D -> G [label = 'Aneurysm remains stable']
      E -> H [label = 'Aneurysm is clipped']
      E -> I [label = 'Aneurysm is coiled']
      F -> J [label = 'Patient dies']
      F -> K [label = 'Patient becomes disabled']
      F -> L [label = 'Patient survives in good health']
      G -> M [label = 'Patient anxious from aneurysm']
      G -> N [label = 'Patient not anxious and in good health']
      H -> O [label = 'Patient dies']
      H -> P [label = 'Patient becomes disabled']
      H -> Q [label = 'Patient survives in good health']
      I -> R [label = 'Patient dies']
      I -> S [label = 'Patient becomes disabled']
      I -> T [label = 'Patient survives in good health']
      J -> 1
      K -> 2
      L -> 3
      M -> 4
      N -> 5
      O -> 6
      P -> 7
      Q -> 8
      R -> 9
      S -> 10
      T -> 11
      }
"
diagram_2 <- "
digraph {

      # graph attributes
      graph [overlap = true, 
             rankdir = LR]

      # edge attributes
      edge [color = gray]

      # node statements
      node [shape = box,
      fontname = Helvetica,
      color = gray,
      label = '']
      A [label = Detection] 
      
      # node statements
      node [shape = oval,
      fontname = Helvetica,
      color = gray]
      B [label = 'Watchful waiting'] 
      C [label = 'Aneurysm treatment'] 
      
      # node attributes
      node [shape = circle, 
      width = 0.5,
      color = black,
      label = ' ']
      D; E
      
      # node attributes
      node [shape = circle, 
      width = 0.5,
      color = black,
      label = ' ']
      F; G; H; I 
      
       # node statements
      node [shape = box,
      fontname = Helvetica,
      color = gray]
      
      J [label = A]
      K [label = B]
      L [label = C]
      M [label = D]
      N [label = E]
      O [label = F]
      P [label = G]
      Q [label = H]
      R [label = I]
      S [label = J]
      T [label = K]
      
      
      1 [label = 'e_path_A, c_path_A']
      2 [label = 'e_path_B, c_path_B']
      3 [label = 'e_path_C, c_path_C']
      4 [label = 'e_path_D, c_path_D']
      5 [label = 'e_path_E, c_path_E']
      6 [label = 'e_path_F, c_path_F']
      7 [label = 'e_path_G, c_path_G']
      8 [label = 'e_path_H, c_path_H']
      9 [label = 'e_path_I, c_path_I']
      10 [label = 'e_path_J, c_path_J']
      11 [label = 'e_path_K, c_path_K']
      
      # edge statements
      A -> B [arrowhead = none]
      A -> C [arrowhead = none]
      B -> D 
      C -> E
      D -> F [label = 'p_Rupture'] 
      D -> G [label = 'p_Stable']
      E -> H [label = 'p_Clipping']
      E -> I [label = 'p_Coiling']
      F -> J [label = 'p_DeathRupture']
      F -> K [label = 'p_DisabledRupture']
      F -> L [label = 'p_SurvivalRupture']
      G -> M [label = 'p_Anxious']
      G -> N [label = 'p_NotAnxious ']
      H -> O [label = 'p_DeathClipping']
      H -> P [label = 'p_DisabledClipping']
      H -> Q [label = 'p_SurvivalClipping']
      I -> R [label = 'p_DeathCoiling']
      I -> S [label = 'p_DisabledCoiling']
      I -> T [label = 'p_SurvivalCoiling']
      J -> 1
      K -> 2
      L -> 3
      M -> 4
      N -> 5
      O -> 6
      P -> 7
      Q -> 8
      R -> 9
      S -> 10
      T -> 11
      }
"

# Probabilities
p_Rupture <- 0.3 # Probability of Aneurysm rupture
p_Stable <- 0 # Probability of Aneurysm remaining stable
p_DeathRupture <- 0.4 # Probability of death when Aneurysm is ruptured
p_DisabledRupture <- 0.35 # Probability of disability when Aneurysm is ruptured
p_SurvivalRupture <- 0.25 # Probability of surviving and being in good health when Aneurysm is ruptured
p_Anxious <- 0.6 # Probability of being anxious when Aneurysm remains stable
p_NotAnxious <- 0.4 # Probability of not being anxious (and being in good health) when Aneurysm remains stable
p_Clipping <- 0.3 # Probability of clipping the Aneurysm
p_Coiling <- 0.7 # Probability of coiling the Aneurysm
p_DeathClipping <- 0 # Probability of death when Aneurysm is clipped
p_DisabledClipping <- 0.25 # Probability of disability when Aneurysm is clipped
p_SurvivalClipping <- 0.65 # Probability of surviving and being in good health when Aneurysm is clipped
p_DeathCoiling <- 0.05 # Probability of death when Aneurysm is coiled
p_DisabledCoiling <- 0 # Probability of disability when Aneurysm is coiled
p_SurvivalCoiling <- 0.8 # Probability of surviving and being in good health when Aneurysm is coiled

# Utility values
u_Healthy  <- 0.80 # Utility of patient in good health
u_Disabled <- 0.40 # Utility of disabled patient
u_Anxious  <- 0.70 # Utility of anxious patient
u_Death    <- 0    # Utility of dying

# Costs
c_Rupture   <- 50000 # Cost of Aneurysm rupture
c_Clipping	<- 20000 # Cost of Aneurysm clipping
c_Coiling   <- 13000 # Cost of Aneurysm coiling
c_Disabled  <- 5000  # Cost of disabled patient

knitr::opts_chunk$set(echo = FALSE)
```

## Decision tree

### Aim and instructions
The aim of this practical assignment is to perform a health economic analysis using a decision tree. You are asked to evaluating the cost-effectiveness of a treatment strategy for patients with unruptured intracranial aneurysms versus watchful waiting.  

**NOTE**: the solutions which are provided are one way to perform the calculations, you can obtain the same results using other fomula's. The last 'Hint' is always the solution of the assignment. Soultions can be copy/paste in the chunk as shown in the figures below. Once you have completed a code chunk, you can run it by pushing the 'Run code' button on the upper-right side of the chunk.  


```{r, fig.align = 'center', out.width = "70%", echo = F}
knitr::include_graphics("Tutorial_decision_tree_files/images/Image_hint.png")
```

```{r, fig.align = 'center', out.width = "70%", echo = F}
knitr::include_graphics("Tutorial_decision_tree_files/images/Image_solution.png")
```

## The decision tree
This section provides an explanation of the decision tree used in this practical assignment. The decision tree compares two strategies: "Aneurysm treatment" and "Watchful waiting". The "Detection" rectangle represents the **decision node** (i.e. the point where the different strategies are defined). Both main branches of the decision tree describe the possible trajectories for each of the strategies: the treatment strategy and "watchful waiting". The circles are the **chance nodes**. The different trajectories that individuals can follow are called **pathways**. Each pathway is associated with **rewards** or outcomes. In this case, the outcomes are utility values (health effects) and costs.  
Figure 1 provides a textual description of the trajectories, and Figure 2 provides a description of which probabilities belongs to each branch of the decision tree.  
**NOTE**: 

 - the label of each arrow is on top of each arrow  
 - the sum of the probabilities following a chance node must sum up to 1  

```{r diags_1}
grVizOutput("graph_text")
grVizOutput("graph_text_probs")

```

```{r diags_1_serv, context = "server"}
output$graph_text <- renderGrViz({
  grViz({
    diagram_1
    })
  })

output$graph_text_probs <- renderGrViz({
 grViz({
   diagram_2
     })
   })
```


## Step 1: Define parameters 
This part of the assignment aims at defining the different parameters of the decision tree. In the following R code chunk, you can see the different parameters of the decision tree. The definition of each parameter follows in the comment.  

```{r params, echo = TRUE}
# Probabilities
p_Rupture <- 0.3 # Probability of Aneurysm rupture
p_Stable <- 0 # Probability of Aneurysm remaining stable
p_DeathRupture <- 0.4 # Probability of death when Aneurysm is ruptured
p_DisabledRupture <- 0.35 # Probability of disability when Aneurysm is ruptured
p_SurvivalRupture <- 0.25 # Probability of surviving and being in good health when Aneurysm is ruptured
p_Anxious <- 0.6 # Probability of being anxious when Aneurysm remains stable
p_NotAnxious <- 0.4 # Probability of not being anxious (and being in good health) when Aneurysm remains stable
p_Clipping <- 0.3 # Probability of clipping the Aneurysm
p_Coiling <- 0.7 # Probability of coiling the Aneurysm
p_DeathClipping <- 0 # Probability of death when Aneurysm is clipped
p_DisabledClipping <- 0.25 # Probability of disability when Aneurysm is clipped
p_SurvivalClipping <- 0.65 # Probability of surviving and being in good health when Aneurysm is clipped
p_DeathCoiling <- 0.05 # Probability of death when Aneurysm is coiled
p_DisabledCoiling <- 0 # Probability of disability when Aneurysm is coiled
p_SurvivalCoiling <- 0.8 # Probability of surviving and being in good health when Aneurysm is coiled

# Utility values
u_Healthy  <- 0.80 # Utility of patient in good health
u_Disabled <- 0.40 # Utility of disabled patient
u_Anxious  <- 0.70 # Utility of anxious patient
u_Death    <- 0    # Utility of dying

# Costs
c_Rupture   <- 50000 # Cost of Aneurysm rupture
c_Clipping	<- 20000 # Cost of Aneurysm clipping
c_Coiling   <- 13000 # Cost of Aneurysm coiling
c_Disabled  <- 5000  # Cost of disabled patient
```

As you can see, the `p_Stable`, `p_DeathClipping` and `p_DisabledCoiling` are not defined. Calculate `p_Stable`, `p_DeathClipping` and `p_DisabledCoiling` using the already defined probabilities and the diagram of the decision tree diagram displayed provided on the previous tab.  

```{r calc_probs, exercise = TRUE}
p_Stable  
p_DeathClipping 
p_DisabledCoiling
```

```{r calc_probs-hint}
"Use <- to assign the values. remember that the sum of probabilities stemming from a decision node should be equal to 1."
```

```{r calc_probs-solution}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling
``` 

## Step 2: Calculate probabilities of pathways
Now that we have calculated all probabilities of the decision tree, we have to calculate the probabilities associated with each pathway (A to K).  

### Calculations
```{r setup_p_path}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling
```
Calculate the probabilities of each pathway using the probabilities defined in the previous step. To facilitate it, the `p_Stable`, `p_DeathClipping` and `p_DisabledCoiling` have been loaded for this exercise.  
Allocate the probabilities to the objects below. `p_path_` means "Probability of pathway".  

```{r calc_p_pathways, exercise = TRUE, exercise.setup = "setup_p_path"}
p_path_A
p_path_B
p_path_C
p_path_D
p_path_E
p_path_F
p_path_G
p_path_H
p_path_I
p_path_J
p_path_K
```

```{r calc_p_pathways-hint-1}
"The probability of a pathway is obtained by multiplying the probabilities leading to a final node of the graph."
```

```{r calc_p_pathways-hint-2}
p_path_A <- p_Rupture * p_DeathRupture # Example: the probability of the pathway A is the multiplication of 
```

```{r calc_p_pathways-solution}
p_path_A <- p_Rupture * p_DeathRupture
p_path_B <- p_Rupture * p_DisabledRupture
p_path_C <- p_Rupture * p_SurvivalRupture
p_path_D <- p_Stable * p_Anxious
p_path_E <- p_Stable * p_NotAnxious
p_path_F <- p_Clipping * p_DeathClipping
p_path_G <- p_Clipping * p_DisabledClipping
p_path_H <- p_Clipping * p_SurvivalClipping
p_path_I <- p_Coiling * p_DeathCoiling
p_path_J <- p_Coiling * p_DisabledCoiling
p_path_K <- p_Coiling * p_SurvivalCoiling
```

### Answers
The probability of the pathway should be the following:
```{r res_calc_p_pathways}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

`Probability of pathway A` <- p_Rupture * p_DeathRupture
`Probability of pathway B` <- p_Rupture * p_DisabledRupture
`Probability of pathway C` <- p_Rupture * p_SurvivalRupture
`Probability of pathway D` <- p_Stable * p_Anxious
`Probability of pathway E` <- p_Stable * p_NotAnxious
`Probability of pathway F` <- p_Clipping * p_DeathClipping
`Probability of pathway G` <- p_Clipping * p_DisabledClipping
`Probability of pathway H` <- p_Clipping * p_SurvivalClipping
`Probability of pathway I` <- p_Coiling * p_DeathCoiling
`Probability of pathway J` <- p_Coiling * p_DisabledCoiling
`Probability of pathway K` <- p_Coiling * p_SurvivalCoiling

data.frame(
  Names = c("Probability of pathway A",
            "Probability of pathway B",
            "Probability of pathway C",
            "Probability of pathway D",
            "Probability of pathway E",
            "Probability of pathway F",
            "Probability of pathway G",
            "Probability of pathway H",
            "Probability of pathway I",
            "Probability of pathway J",
            "Probability of pathway K",
            "Sum of probabilities"),
  Probabilities = c(`Probability of pathway A`,
                    `Probability of pathway B`,
                    `Probability of pathway C`,
                    `Probability of pathway D`,
                    `Probability of pathway E`,
                    `Probability of pathway F`,
                    `Probability of pathway G`,
                    `Probability of pathway H`,
                    `Probability of pathway I`,
                    `Probability of pathway J`,
                    `Probability of pathway K`,
                    sum(c(`Probability of pathway A`,
                    `Probability of pathway B`,
                    `Probability of pathway C`,
                    `Probability of pathway D`,
                    `Probability of pathway E`,
                    `Probability of pathway F`,
                    `Probability of pathway G`,
                    `Probability of pathway H`,
                    `Probability of pathway I`,
                    `Probability of pathway J`,
                    `Probability of pathway K`))
                    )
  )
```

## Step 3: Assign outcomes to pathways
This steps consists of calculating the costs and effects attributed to each pathway.  

### Utility value of each pathway
Assign the utility values to each pathway. The pathways are described at the beginning of the tutorial. For your convenience, the utility values are displayed here once again.

```{r utils_show, eval = FALSE, echo = TRUE}
# Utility values
u_Healthy  <- 0.80 # Utility of patient in good health
u_Disabled <- 0.40 # Utility of disabled patient
u_Anxious  <- 0.70 # Utility of anxious patient
u_Death    <- 0    # Utility of dying
```

In the code chunk below `e_path_A` means "effects associated with pathway A".
```{r assign_utils, exercise = TRUE}
e_path_A 
e_path_B  
e_path_C 
e_path_D 
e_path_E 
e_path_F 
e_path_G 
e_path_H 
e_path_I 
e_path_J 
e_path_K 
```

```{r assign_utils-hint-1}
"Use <- to assign the utility values to the effectiveness outcome of the pathways"
```

```{r assign_utils-hint-2}
e_path_A <- u_Death # Example for pathway A
```

```{r assign_utils-solution}
e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy
```

### Costs of each pathway
Assign the costs to each pathway. The pathways are described at the beginning of the tutorial. For your convenience, the costs are displayed here once again.

```{r costs_show, eval = FALSE, echo = TRUE}
# Costs
c_Rupture   <- 50000 # Cost of Aneurysm rupture
c_Clipping	<- 20000 # Cost of Aneurysm clipping
c_Coiling   <- 13000 # Cost of Aneurysm coiling
c_Disabled  <- 5000  # Cost of disabled patient
```

In the code chunk below `c_path_A` means "costs associated with pathway A".
```{r assign_costs, exercise = TRUE}
c_path_A 
c_path_B  
c_path_C 
c_path_D 
c_path_E 
c_path_F 
c_path_G 
c_path_H 
c_path_I 
c_path_J 
c_path_K 
```

```{r assign_costs-hint-1}
"Use <- to assign the costs outcome to the pathways"
```

```{r assign_costs-hint-2}
c_path_A <- c_Rupture # Example for pathway A
```

```{r assign_costs-solution}
c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling
```

### Overview effects and costs of pathways
```{r overview_e_c}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy

c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling

data.frame(
  Pathway = c("A",
            "B",
            "C",
            "D",
            "E",
            "F",
            "G",
            "H",
            "I",
            "J",
            "K"
            ),
  Effects = c(e_path_A,
              e_path_B,
              e_path_C,
              e_path_D,
              e_path_E,
              e_path_F,
              e_path_G,
              e_path_H,
              e_path_I,
              e_path_J,
              e_path_K),
  Costs = c(c_path_A,
              c_path_B,
              c_path_C,
              c_path_D,
              c_path_E,
              c_path_F,
              c_path_G,
              c_path_H,
              c_path_I,
              c_path_J,
              c_path_K)
  )
```

## Step 4: Calculate expected effects and costs of pathways
We have just calculated the utility values and costs of each pathway. These utility values and costs are the outcomes that an individual would obtain if he/she would follow a specific pathway. However, only a proportion of individuals will follow a specific pathway, based on the probabilities of each of these pathways. Therefore, to calculate the total expected outcomes of each strategy, we first have to calculate the **expected** utility values and costs of each pathway. These are obtained by multiplying the probabilities of each pathway by their outcomes: their utility value and costs.  

### Calculations  
Calculate the expected utility values and costs of each pathway in the following chunk. To do so, use the probabilities, utility values, and costs of each pathway that we have defined in Steps 2 and 3. In the following code chunk, `t_e_path_A` means "total expected utility values (effects) of pathway A" and `t_c_path_A` means "total expected costs of pathway A" and so on for the other pathways. For your convenience, the probabilities (`p_path_` objects), utility values (`e_path_` objects), and costs (`c_path_` objects) of each pathway have been loaded and can be used to perform these calculations.  

```{r setup_calc_out}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

# Probabilities
p_path_A <- p_Rupture * p_DeathRupture
p_path_B <- p_Rupture * p_DisabledRupture
p_path_C <- p_Rupture * p_SurvivalRupture
p_path_D <- p_Stable * p_Anxious
p_path_E <- p_Stable * p_NotAnxious
p_path_F <- p_Clipping * p_DeathClipping
p_path_G <- p_Clipping * p_DisabledClipping
p_path_H <- p_Clipping * p_SurvivalClipping
p_path_I <- p_Coiling * p_DeathCoiling
p_path_J <- p_Coiling * p_DisabledCoiling
p_path_K <- p_Coiling * p_SurvivalCoiling

# Effects
e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy

# Costs
c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling
```

```{r calc_outcomes, exercise = TRUE, exercise.setup = "setup_calc_out"}
# Expected effects
t_e_path_A
t_e_path_B
t_e_path_C
t_e_path_D
t_e_path_E
t_e_path_F
t_e_path_G
t_e_path_H
t_e_path_I
t_e_path_J
t_e_path_K

# Expected costs
t_c_path_A
t_c_path_B
t_c_path_C
t_c_path_D
t_c_path_E
t_c_path_F
t_c_path_G
t_c_path_H
t_c_path_I
t_c_path_J
t_c_path_K
```

```{r calc_outcomes-hint-1}
"Multiply the probability of each pathway by their utility value (effects) and costs"
```

```{r calc_outcomes-hint-2}
t_e_path_A <- p_path_A * e_path_A # Example for expected utility values of pathway A
t_c_path_A <- p_path_A * c_path_A # Example for expected costs of pathway A
```

```{r calc_outcomes-solution}
t_e_path_A <- p_path_A * e_path_A
t_e_path_B <- p_path_B * e_path_B
t_e_path_C <- p_path_C * e_path_C
t_e_path_D <- p_path_D * e_path_D
t_e_path_E <- p_path_E * e_path_E
t_e_path_F <- p_path_F * e_path_F
t_e_path_G <- p_path_G * e_path_G
t_e_path_H <- p_path_H * e_path_H
t_e_path_I <- p_path_I * e_path_I
t_e_path_J <- p_path_J * e_path_J
t_e_path_K <- p_path_K * e_path_K

t_c_path_A <- p_path_A * c_path_A
t_c_path_B <- p_path_B * c_path_B
t_c_path_C <- p_path_C * c_path_C
t_c_path_D <- p_path_D * c_path_D
t_c_path_E <- p_path_E * c_path_E
t_c_path_F <- p_path_F * c_path_F
t_c_path_G <- p_path_G * c_path_G
t_c_path_H <- p_path_H * c_path_H
t_c_path_I <- p_path_I * c_path_I
t_c_path_J <- p_path_J * c_path_J
t_c_path_K <- p_path_K * c_path_K
```

### Overview expected effects and costs
```{r overview_t_e_c_show}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

p_path_A <- p_Rupture * p_DeathRupture
p_path_B <- p_Rupture * p_DisabledRupture
p_path_C <- p_Rupture * p_SurvivalRupture
p_path_D <- p_Stable * p_Anxious
p_path_E <- p_Stable * p_NotAnxious
p_path_F <- p_Clipping * p_DeathClipping
p_path_G <- p_Clipping * p_DisabledClipping
p_path_H <- p_Clipping * p_SurvivalClipping
p_path_I <- p_Coiling * p_DeathCoiling
p_path_J <- p_Coiling * p_DisabledCoiling
p_path_K <- p_Coiling * p_SurvivalCoiling

e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy

c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling

t_e_path_A <- p_path_A * e_path_A
t_e_path_B <- p_path_B * e_path_B
t_e_path_C <- p_path_C * e_path_C
t_e_path_D <- p_path_D * e_path_D
t_e_path_E <- p_path_E * e_path_E
t_e_path_F <- p_path_F * e_path_F
t_e_path_G <- p_path_G * e_path_G
t_e_path_H <- p_path_H * e_path_H
t_e_path_I <- p_path_I * e_path_I
t_e_path_J <- p_path_J * e_path_J
t_e_path_K <- p_path_K * e_path_K

t_c_path_A <- p_path_A * c_path_A
t_c_path_B <- p_path_B * c_path_B
t_c_path_C <- p_path_C * c_path_C
t_c_path_D <- p_path_D * c_path_D
t_c_path_E <- p_path_E * c_path_E
t_c_path_F <- p_path_F * c_path_F
t_c_path_G <- p_path_G * c_path_G
t_c_path_H <- p_path_H * c_path_H
t_c_path_I <- p_path_I * c_path_I
t_c_path_J <- p_path_J * c_path_J
t_c_path_K <- p_path_K * c_path_K

data.frame(
  Pathway = c("A",
            "B",
            "C",
            "D",
            "E",
            "F",
            "G",
            "H",
            "I",
            "J",
            "K"
            ),
  Probabilities = c(p_path_A,
                    p_path_B,
                    p_path_C,
                    p_path_D,
                    p_path_E,
                    p_path_F,
                    p_path_G,
                    p_path_H,
                    p_path_I,
                    p_path_J,
                    p_path_K),
  Effects = c(t_e_path_A,
              t_e_path_B,
              t_e_path_C,
              t_e_path_D,
              t_e_path_E,
              t_e_path_F,
              t_e_path_G,
              t_e_path_H,
              t_e_path_I,
              t_e_path_J,
              t_e_path_K),
  Costs = c(t_c_path_A,
            t_c_path_B,
            t_c_path_C,
            t_c_path_D,
            t_c_path_E,
            t_c_path_F,
            t_c_path_G,
            t_c_path_H,
            t_c_path_I,
            t_c_path_J,
            t_c_path_K)
  )
```

## Step 5: Calculate expected effects and costs of each strategy
Now that we have calculated the expected outcomes of each pathway, we can finally calculate the expected outcomes of each strategy! This can be done by summing up all expected outcomes per strategy 

### Calculations
Calculate these expected outcomes in the following chunk. for your convenience, the `t_e_path_` and `t_c_path_` have been loaded and can be used to perform these calculations.  

```{r setup_calc_strat_out}
# Calculation missing probabilities
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

# Probabilities
p_path_A <- p_Rupture * p_DeathRupture
p_path_B <- p_Rupture * p_DisabledRupture
p_path_C <- p_Rupture * p_SurvivalRupture
p_path_D <- p_Stable * p_Anxious
p_path_E <- p_Stable * p_NotAnxious
p_path_F <- p_Clipping * p_DeathClipping
p_path_G <- p_Clipping * p_DisabledClipping
p_path_H <- p_Clipping * p_SurvivalClipping
p_path_I <- p_Coiling * p_DeathCoiling
p_path_J <- p_Coiling * p_DisabledCoiling
p_path_K <- p_Coiling * p_SurvivalCoiling

# Effects
e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy

# Costs
c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling

# Total expected effects
t_e_path_A <- p_path_A * e_path_A
t_e_path_B <- p_path_B * e_path_B
t_e_path_C <- p_path_C * e_path_C
t_e_path_D <- p_path_D * e_path_D
t_e_path_E <- p_path_E * e_path_E
t_e_path_F <- p_path_F * e_path_F
t_e_path_G <- p_path_G * e_path_G
t_e_path_H <- p_path_H * e_path_H
t_e_path_I <- p_path_I * e_path_I
t_e_path_J <- p_path_J * e_path_J
t_e_path_K <- p_path_K * e_path_K

# Total expected costs
t_c_path_A <- p_path_A * c_path_A
t_c_path_B <- p_path_B * c_path_B
t_c_path_C <- p_path_C * c_path_C
t_c_path_D <- p_path_D * c_path_D
t_c_path_E <- p_path_E * c_path_E
t_c_path_F <- p_path_F * c_path_F
t_c_path_G <- p_path_G * c_path_G
t_c_path_H <- p_path_H * c_path_H
t_c_path_I <- p_path_I * c_path_I
t_c_path_J <- p_path_J * c_path_J
t_c_path_K <- p_path_K * c_path_K
```

```{r calc_out_strat, exercise = TRUE, exercise.setup = "setup_calc_strat_out"}
t_e_ww  # expected effects "watchful waiting" strategy
t_c_ww  # expected costs "watchful waiting" strategy

t_e_trt # expected effects treatment strategy
t_c_trt # expected costs treatment strategy

```

```{r calc_out_strat-hint}
"Use the sum() function or +"
```

```{r calc_out_strat-solution}
t_e_ww  <- sum(t_e_path_A, t_e_path_B, t_e_path_C, t_e_path_D, t_e_path_E)
t_c_ww  <- sum(t_c_path_A, t_c_path_B, t_c_path_C, t_c_path_D, t_c_path_E)
t_e_trt <- sum(t_e_path_F, t_e_path_G, t_e_path_H, t_e_path_I, t_e_path_J, t_e_path_K)
t_c_trt <- sum(t_c_path_F, t_c_path_G, t_c_path_H, t_c_path_I, t_c_path_J, t_c_path_K)
```

### Overview totals per strategy
```{r overview_t_e_c}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

p_path_A <- p_Rupture * p_DeathRupture
p_path_B <- p_Rupture * p_DisabledRupture
p_path_C <- p_Rupture * p_SurvivalRupture
p_path_D <- p_Stable * p_Anxious
p_path_E <- p_Stable * p_NotAnxious
p_path_F <- p_Clipping * p_DeathClipping
p_path_G <- p_Clipping * p_DisabledClipping
p_path_H <- p_Clipping * p_SurvivalClipping
p_path_I <- p_Coiling * p_DeathCoiling
p_path_J <- p_Coiling * p_DisabledCoiling
p_path_K <- p_Coiling * p_SurvivalCoiling

e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy

c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling

t_e_path_A <- p_path_A * e_path_A
t_e_path_B <- p_path_B * e_path_B
t_e_path_C <- p_path_C * e_path_C
t_e_path_D <- p_path_D * e_path_D
t_e_path_E <- p_path_E * e_path_E
t_e_path_F <- p_path_F * e_path_F
t_e_path_G <- p_path_G * e_path_G
t_e_path_H <- p_path_H * e_path_H
t_e_path_I <- p_path_I * e_path_I
t_e_path_J <- p_path_J * e_path_J
t_e_path_K <- p_path_K * e_path_K

t_c_path_A <- p_path_A * c_path_A
t_c_path_B <- p_path_B * c_path_B
t_c_path_C <- p_path_C * c_path_C
t_c_path_D <- p_path_D * c_path_D
t_c_path_E <- p_path_E * c_path_E
t_c_path_F <- p_path_F * c_path_F
t_c_path_G <- p_path_G * c_path_G
t_c_path_H <- p_path_H * c_path_H
t_c_path_I <- p_path_I * c_path_I
t_c_path_J <- p_path_J * c_path_J
t_c_path_K <- p_path_K * c_path_K

t_e_ww  <- sum(t_e_path_A, t_e_path_B, t_e_path_C, t_e_path_D, t_e_path_E)
t_c_ww  <- sum(t_c_path_A, t_c_path_B, t_c_path_C, t_c_path_D, t_c_path_E)
t_e_trt <- sum(t_e_path_F, t_e_path_G, t_e_path_H, t_e_path_I, t_e_path_J, t_e_path_K)
t_c_trt <- sum(t_c_path_F, t_c_path_G, t_c_path_H, t_c_path_I, t_c_path_J, t_c_path_K)

data.frame(
  Strategy = c("Watchful waiting",
               "Treatment"
               ),
  `Total effects` = c(t_e_ww,
                         t_e_trt
                         ),
  `Total costs` = c(t_c_ww,
                       t_c_trt
                       )
  )
```

## Step 6: Calculate incremental effects, costs, and incremental cost-effectiveness ratio
Based on the total expected utility value (effects) and costs of both strategies, we can now calculate the incremental effects and costs of the treatment strategy versus "watchful waiting". We can also calculate the incremental cost-effectiveness ratio of the treatment strategy versus "watchful waiting".  

### Calculation  
The total effects and costs defined in previous step have been loaded and can be used to perform these calculations.  
```{r set_up_comparison}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

p_path_A <- p_Rupture * p_DeathRupture
p_path_B <- p_Rupture * p_DisabledRupture
p_path_C <- p_Rupture * p_SurvivalRupture
p_path_D <- p_Stable * p_Anxious
p_path_E <- p_Stable * p_NotAnxious
p_path_F <- p_Clipping * p_DeathClipping
p_path_G <- p_Clipping * p_DisabledClipping
p_path_H <- p_Clipping * p_SurvivalClipping
p_path_I <- p_Coiling * p_DeathCoiling
p_path_J <- p_Coiling * p_DisabledCoiling
p_path_K <- p_Coiling * p_SurvivalCoiling

e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy

c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling

t_e_path_A <- p_path_A * e_path_A
t_e_path_B <- p_path_B * e_path_B
t_e_path_C <- p_path_C * e_path_C
t_e_path_D <- p_path_D * e_path_D
t_e_path_E <- p_path_E * e_path_E
t_e_path_F <- p_path_F * e_path_F
t_e_path_G <- p_path_G * e_path_G
t_e_path_H <- p_path_H * e_path_H
t_e_path_I <- p_path_I * e_path_I
t_e_path_J <- p_path_J * e_path_J
t_e_path_K <- p_path_K * e_path_K

t_c_path_A <- p_path_A * c_path_A
t_c_path_B <- p_path_B * c_path_B
t_c_path_C <- p_path_C * c_path_C
t_c_path_D <- p_path_D * c_path_D
t_c_path_E <- p_path_E * c_path_E
t_c_path_F <- p_path_F * c_path_F
t_c_path_G <- p_path_G * c_path_G
t_c_path_H <- p_path_H * c_path_H
t_c_path_I <- p_path_I * c_path_I
t_c_path_J <- p_path_J * c_path_J
t_c_path_K <- p_path_K * c_path_K

t_e_ww  <- sum(t_e_path_A, t_e_path_B, t_e_path_C, t_e_path_D, t_e_path_E)
t_c_ww  <- sum(t_c_path_A, t_c_path_B, t_c_path_C, t_c_path_D, t_c_path_E)
t_e_trt <- sum(t_e_path_F, t_e_path_G, t_e_path_H, t_e_path_I, t_e_path_J, t_e_path_K)
t_c_trt <- sum(t_c_path_F, t_c_path_G, t_c_path_H, t_c_path_I, t_c_path_J, t_c_path_K)
```

```{r calc_final, exercise = TRUE, exercise.setup = "set_up_comparison"}
inc_e_trt # incremental effects
inc_c_trt # incremental costs
icer# incremental cost-effectiveness ratio
```

```{r calc_final-hint}
"The incremental effects (and costs) of the treatment strategy are calculated as the difference in effects (costs) between the treatment strategy and the watchful waiting strategy. The incremental cost-effectiveness ratio (ICER) is the ratio of the incremental costs by the incremental effects."
```

```{r calc_final-solution}
inc_e_trt <- t_e_trt - t_e_ww
inc_c_trt <- t_c_trt - t_c_ww
icer <- inc_c_trt / inc_e_trt
```

### Overview final results
```{r overview_comparison}
p_Stable <- 1 - p_Rupture 
p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling

p_path_A <- p_Rupture * p_DeathRupture
p_path_B <- p_Rupture * p_DisabledRupture
p_path_C <- p_Rupture * p_SurvivalRupture
p_path_D <- p_Stable * p_Anxious
p_path_E <- p_Stable * p_NotAnxious
p_path_F <- p_Clipping * p_DeathClipping
p_path_G <- p_Clipping * p_DisabledClipping
p_path_H <- p_Clipping * p_SurvivalClipping
p_path_I <- p_Coiling * p_DeathCoiling
p_path_J <- p_Coiling * p_DisabledCoiling
p_path_K <- p_Coiling * p_SurvivalCoiling

e_path_A <- u_Death
e_path_B <- u_Disabled 
e_path_C <- u_Healthy
e_path_D <- u_Anxious
e_path_E <- u_Healthy
e_path_F <- u_Death
e_path_G <- u_Disabled
e_path_H <- u_Healthy
e_path_I <- u_Death
e_path_J <- u_Disabled
e_path_K <- u_Healthy

c_path_A <- c_Rupture
c_path_B <- c_Rupture + c_Disabled
c_path_C <- c_Rupture
c_path_D <- 0
c_path_E <- 0
c_path_F <- c_Clipping
c_path_G <- c_Clipping + c_Disabled
c_path_H <- c_Clipping
c_path_I <- c_Coiling
c_path_J <- c_Coiling + c_Disabled
c_path_K <- c_Coiling

t_e_path_A <- p_path_A * e_path_A
t_e_path_B <- p_path_B * e_path_B
t_e_path_C <- p_path_C * e_path_C
t_e_path_D <- p_path_D * e_path_D
t_e_path_E <- p_path_E * e_path_E
t_e_path_F <- p_path_F * e_path_F
t_e_path_G <- p_path_G * e_path_G
t_e_path_H <- p_path_H * e_path_H
t_e_path_I <- p_path_I * e_path_I
t_e_path_J <- p_path_J * e_path_J
t_e_path_K <- p_path_K * e_path_K

t_c_path_A <- p_path_A * c_path_A
t_c_path_B <- p_path_B * c_path_B
t_c_path_C <- p_path_C * c_path_C
t_c_path_D <- p_path_D * c_path_D
t_c_path_E <- p_path_E * c_path_E
t_c_path_F <- p_path_F * c_path_F
t_c_path_G <- p_path_G * c_path_G
t_c_path_H <- p_path_H * c_path_H
t_c_path_I <- p_path_I * c_path_I
t_c_path_J <- p_path_J * c_path_J
t_c_path_K <- p_path_K * c_path_K

t_e_ww  <- sum(t_e_path_A, t_e_path_B, t_e_path_C, t_e_path_D, t_e_path_E)
t_c_ww  <- sum(t_c_path_A, t_c_path_B, t_c_path_C, t_c_path_D, t_c_path_E)
t_e_trt <- sum(t_e_path_F, t_e_path_G, t_e_path_H, t_e_path_I, t_e_path_J, t_e_path_K)
t_c_trt <- sum(t_c_path_F, t_c_path_G, t_c_path_H, t_c_path_I, t_c_path_J, t_c_path_K)

inc_e_trt <- t_e_trt - t_e_ww
inc_c_trt <- t_c_trt - t_c_ww
icer <- inc_c_trt / inc_e_trt

data.frame(
  Strategy = c("Watchful waiting",
               "Treatment"
               ),
  `Total effects` = c(t_e_ww,
                      t_e_trt
                         ),
  `Total costs` = round(c(t_c_ww,
                    t_c_trt
                       )),
  `Incremental effects` = c("-", 
                            round(inc_e_trt, 2) 
                            ),
  `Incremental costs` = c("-",
                          round(inc_c_trt)
                          ),
  ICER = c("-",
           round(icer)
           )
)
```

## Decision tree complete
In this tab, the decision tree has been filled with the input values of the previous steps. You can change the input values and evaluate what the impact of changing these inputs is on the results. This completed decision tree can be used to answer the questions in the following tab.  

```{r interact_dt}
# Shiny component
numericInput(inputId = "p_Rupture",
             label = "Probability of a rupture in watchful witing strategy",
             value = 0.3,
             min = 0,
             max = 1)
numericInput(inputId = "u_Anxious",
             label = "Utility value of being anxious",
             value = 0.7,
             min = 0,
             max = 1)
numericInput(inputId = "u_Healthy",
             label = "Utility value of being healthy",
             value = 0.8,
             min = 0,
             max = 1)
numericInput(inputId = "p_Clipping",
             label = "Probability of Clipping",
             value = 0.3,
             min = 0,
             max = 1)
numericInput(inputId = "p_Coiling",
             label = "Probability of Coiling",
             value = 0.7,
             min = 0,
             max = 1)
tags$hr()
tableOutput("results")

```

```{r interact_dt_server, context = "server"}
output$results <- renderTable({
  
  p_Rupture <- input$p_Rupture 
  u_Anxious <- input$u_Anxious
  u_Healthy <- input$u_Healthy
  p_Clipping <- input$p_Clipping
  p_Coiling <- input$p_Coiling
  
  p_Stable <- 1 - p_Rupture 
  p_DeathClipping  <- 1 - p_DisabledClipping - p_SurvivalClipping
  p_DisabledCoiling <- 1- p_DeathCoiling - p_SurvivalCoiling
  
  p_path_A <- p_Rupture * p_DeathRupture
  p_path_B <- p_Rupture * p_DisabledRupture
  p_path_C <- p_Rupture * p_SurvivalRupture
  p_path_D <- p_Stable * p_Anxious
  p_path_E <- p_Stable * p_NotAnxious
  p_path_F <- p_Clipping * p_DeathClipping
  p_path_G <- p_Clipping * p_DisabledClipping
  p_path_H <- p_Clipping * p_SurvivalClipping
  p_path_I <- p_Coiling * p_DeathCoiling
  p_path_J <- p_Coiling * p_DisabledCoiling
  p_path_K <- p_Coiling * p_SurvivalCoiling
  
  e_path_A <- u_Death
  e_path_B <- u_Disabled 
  e_path_C <- u_Healthy
  e_path_D <- u_Anxious
  e_path_E <- u_Healthy
  e_path_F <- u_Death
  e_path_G <- u_Disabled
  e_path_H <- u_Healthy
  e_path_I <- u_Death
  e_path_J <- u_Disabled
  e_path_K <- u_Healthy
  
  c_path_A <- c_Rupture
  c_path_B <- c_Rupture + c_Disabled
  c_path_C <- c_Rupture
  c_path_D <- 0
  c_path_E <- 0
  c_path_F <- c_Clipping
  c_path_G <- c_Clipping + c_Disabled
  c_path_H <- c_Clipping
  c_path_I <- c_Coiling
  c_path_J <- c_Coiling + c_Disabled
  c_path_K <- c_Coiling
  
  t_e_path_A <- p_path_A * e_path_A
  t_e_path_B <- p_path_B * e_path_B
  t_e_path_C <- p_path_C * e_path_C
  t_e_path_D <- p_path_D * e_path_D
  t_e_path_E <- p_path_E * e_path_E
  t_e_path_F <- p_path_F * e_path_F
  t_e_path_G <- p_path_G * e_path_G
  t_e_path_H <- p_path_H * e_path_H
  t_e_path_I <- p_path_I * e_path_I
  t_e_path_J <- p_path_J * e_path_J
  t_e_path_K <- p_path_K * e_path_K
  
  t_c_path_A <- p_path_A * c_path_A
  t_c_path_B <- p_path_B * c_path_B
  t_c_path_C <- p_path_C * c_path_C
  t_c_path_D <- p_path_D * c_path_D
  t_c_path_E <- p_path_E * c_path_E
  t_c_path_F <- p_path_F * c_path_F
  t_c_path_G <- p_path_G * c_path_G
  t_c_path_H <- p_path_H * c_path_H
  t_c_path_I <- p_path_I * c_path_I
  t_c_path_J <- p_path_J * c_path_J
  t_c_path_K <- p_path_K * c_path_K
  
  t_e_ww  <- sum(t_e_path_A, t_e_path_B, t_e_path_C, t_e_path_D, t_e_path_E)
  t_c_ww  <- sum(t_c_path_A, t_c_path_B, t_c_path_C, t_c_path_D, t_c_path_E)
  t_e_trt <- sum(t_e_path_F, t_e_path_G, t_e_path_H, t_e_path_I, t_e_path_J, t_e_path_K)
  t_c_trt <- sum(t_c_path_F, t_c_path_G, t_c_path_H, t_c_path_I, t_c_path_J, t_c_path_K)

  t_e_ww  <- sum(t_e_path_A, t_e_path_B, t_e_path_C, t_e_path_D, t_e_path_E)
  t_c_ww  <- sum(t_c_path_A, t_c_path_B, t_c_path_C, t_c_path_D, t_c_path_E)
  t_e_trt <- sum(t_e_path_F, t_e_path_G, t_e_path_H, t_e_path_I, t_e_path_J, t_e_path_K)
  t_c_trt <- sum(t_c_path_F, t_c_path_G, t_c_path_H, t_c_path_I, t_c_path_J, t_c_path_K)

inc_e_trt <- t_e_trt - t_e_ww
inc_c_trt <- t_c_trt - t_c_ww
icer <- inc_c_trt / inc_e_trt

data.frame(
  Strategy = c("Watchful waiting",
               "Treatment"
               ),
  `Total effects` = c(t_e_ww,
                      t_e_trt
                         ),
  `Total costs` = round(c(t_c_ww,
                    t_c_trt
                       )),
  `Incremental effects` = c("-", 
                            round(inc_e_trt, 2) 
                            ),
  `Incremental costs` = c("-",
                          round(inc_c_trt)
                          ),
  ICER = c("-",
           round(icer)
           )
)
  })

```

## Questions concerning the results

### Questions
1. Look at your final results:  

1.a. What is your conclusion?  
```{r open_q_1}
textInput("Answer_1", "Explain your answer")
```

1.b. Which strategy has the most favorable cost-effectiveness if we are willing to pay €20,000 for a gain in utility of 1 (or 1 additional QALY if we assume a one-year time horizon for this decision tree)?  
```{r open_q_2}
textInput("Answer_2", "Explain your answer")
```

1.c. How does the utility of patients with an untreated aneurysm (u_Anxious) affect the cost-effectiveness results? What happens if you disregard any potential anxiety and set u_Anxious equal to u_Healthy?  
```{r open_q_3}
textInput("Answer_3", "Explain your answer")
```

1.d. In the past, aneurysm coiling, which is an endovascular procedure was not yet available in all hospitals. What would you advise to a hospital which only offers aneurysm clipping, should they go with the Watchfull Waiting strategy or with the Aneurysm Treatment (100% clipping) strategy?  
```{r open_q_4}
textInput("Answer_4", "Explain your answer")
```

1.e. And what would you advise to new patients with a detected unruptured aneurysm?  
```{r open_q_5}
textInput("Answer_5", "Explain your answer")
```

2. If you consider extending this decision tree model  
2.a. How would you include evidence suggesting that intracranial aneurysms may remain stable for several years but then start to increase in size and rupture?  
```{r open_q_6}
textInput("Answer_6", "Explain your answer")
```

2.b. It is known that individuals with an unruptured intracranial aneurysm are at increased risk of developing new intracranial aneurysms, regardless of whether the first aneurysm ruptures or remains stable. How would you include the aspect of new aneurysm development in the model?  
```{r open_q_7}
textInput("Answer_7", "Explain your answer")
```

### Discussion answers  
1.a. What is your conclusion?  
**Answer:** From the results we can conclude that the Aneurysm Treatment strategy results in additional health gain at additional costs compared to the Watchful waiting strategy.  
1.b. Which strategy has the most favorable cost-effectiveness if we are willing to pay €20,000 for a gain in utility of 1 (or 1 additional QALY if we assume a one-year time horizon for this decision tree)?  
**Answer:** The Aneurysm Treatment strategy has the most favorable cost-effectiveness if we apply a willingness-to-pay threshold of €20,000/QALY.  
1.c. How does the utility of patients with an untreated aneurysm (`u_Anxious`) affect the cost-effectiveness results? What happens if you disregard any potential anxiety and set uAnxious equal to u_Healthy?  
**Answer:** When `u_Anxious` is set to values much lower then uHealthy than the Watchful waiting strategy results in less and less QALYs. Therefore, the cost-effectiveness of the Aneurysm Treatment strategy compared to the Watchful waiting strategy becomes more and more favorable. If, on the other hand, we set `u_Anxious` equal to `u_Healthy` then NOT treating a patient with a stable aneurysm is a good strategy, as apparently these patient do not suffer from their untreated stable aneurysm in any way. Consequently, the cost-effectiveness of the Aneurysm Treatment strategy compared to the Watchful waiting strategy deteriorates, and we find: incremental costs = €475, incremental effects = 0.014 utility, and incremental cost-effectiveness ratio = €33,929 per QALY. This indicates that the cost-effectiveness of the Aneurysm Treatment strategy compared to the Watchful waiting strategy is no longer acceptable if we apply a willingness-to-pay threshold of €20,000/QALY.    
1.d. In the past, aneurysm coiling, which is an endovascular procedure was not yet available in all hospitals. What would you advise to a hospital which only offers aneurysm clipping, should they go with the Watchfull Waiting strategy or with the Aneurysm Treatment (100% clipping) strategy?  
**Answer:** To answer this question, set `p_Clipping` to 1 and `p_Coiling` to 0 (= all aneurysm treated with clipping). This results in the following outcomes: incremental costs = 5,725 eurors, incremental effects = 0.0 utility, and incremental cost-effectiveness ratio = `Inf` euros per QALY (cannot be calculated because difference in effect is 0). Thus, there is no difference in health outcomes between AneurysmTreatment-ClippingOnly and Watchful Waiting, but the former strategy is much more expensive than the latter! We would therefore advise hospitals which do not perform coiling to follow the Watchful Waiting strategy.  
1.e. And what would you advise to new patients with a detected unruptured aneurysm?  
**Answer:** Find a hospital in which your aneurysm can be coiled. Coiling provides better health outcomes (and is cheaper) than Watchful Waiting or Clipping.  
2. If you consider extending this decision tree model  
2.a. How would you include evidence suggesting that intracranial aneurysms may remain stable for several years but then start to increase in size and rupture?  
**Answer:** Incorporating time explicitly in a decision tree model is hard and will make your model very complex. To allow aneurysms to remain stable and to increase in size and rupture later on chance nodes would need to be added for each separate year in the time horizon. This means the entire model (now defined for 1 year) would needs to be extended to 10 times its current size to allow a time horizon of 10 years.  
2.b. It is known that individuals with an unruptured intracranial aneurysm are at increased risk of developing new intracranial aneurysms, regardless of whether the first aneurysm ruptures or remains stable. How would you include the aspect of new aneurysm development in the model?  
**Answer:** Development of new aneurysm would require additional branches to be added to the tree. A new branch would need to be added for patients with 2 aneurysm, another for patients with 3 aneurysms etc. This extension would therefore only be feasible for patients with 1, 2, or 3+ aneurysms and even then the resulting decision tree would be huge.  

**THE END**
