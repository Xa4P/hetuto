---
title: "Tutorial"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
description: >
  Learn how to build a simple cohort simulation using a
  health state transition (Markov) model.
---

```{r setup, include=FALSE}
rm(list = ls())
require(learnr, quietly = TRUE)
knitr::opts_chunk$set(echo = FALSE)

# Probabilities
p_NewAneurysm       <- 	0.10 # Probability that an individual develops a new intracranial aneurysm 
p_AneurysmDetection <- 	0.50 # Probability that a newly developed aneurysm is detected
p_TreatmentIsFatal  <- 	0.20 # Probability that treatment of a detected aneurysm induces a fatal complication
p_DeathOther        <- 	0.10 # Probability of death due to causes unrelated to aneurysms


# function determine m_tp
determine_m_tp <- function() {
  v_names_hs <- c("Healthy", "NewAneurysm",	"DetectedAneurysm", "DeathOther",	"DeathTreatment")
  n_hs <- length(v_names_hs) # this equals 5
  
  m_tp <- matrix(0, 
                 ncol = n_hs, # or 5
                 nrow = n_hs, # or 5
                 dimnames = list(v_names_hs,
                                 v_names_hs)
                 )
  m_tp["Healthy", "Healthy"]     <- 1- p_NewAneurysm - p_DeathOther
  m_tp["Healthy", "DeathOther"]  <- p_DeathOther
  m_tp["Healthy", "NewAneurysm"] <- p_NewAneurysm
  m_tp["NewAneurysm", "DetectedAneurysm"] <- p_AneurysmDetection
  m_tp["NewAneurysm", "DeathOther"] <- p_DeathOther
  m_tp["NewAneurysm", "NewAneurysm"] <- 1 - p_AneurysmDetection - p_DeathOther
  m_tp["DetectedAneurysm", "Healthy"] <- 1 - p_TreatmentIsFatal
  m_tp["DetectedAneurysm", "DeathTreatment"] <- p_TreatmentIsFatal
  m_tp["DeathOther", "DeathOther"] <- 1
  m_tp["DeathTreatment", "DeathTreatment"] <- 1
  
  return(m_tp)
}
```

## Before starting
1. Watch the video explaining how a HSTM work and can be used for a cost-effectiveness analyses (CEA). To do so, you probably need to open open the tutorial in your browser using the 'Open in Browser' button on the upper left side of the screen.  
![](https://vimeo.com/453418864/050bf4acaf){width="70%"}
Link to the video: https://vimeo.com/453418864/050bf4acaf.

## Aim and instructions
The aim of this practical assignment is to get you acquainted with the principle of health state transition models (HSTM). To do so, you will define a transition matrix for a simple HSTM and explore how you can use it to define your cohort simulation. The example used in the practical focuses on evaluating the life course of patients at risk of developing intracranial aneurysms using a HSTM. The model structure is provided in the next tab.    

```{r, fig.align = 'center', out.width = "70%", echo = F}
knitr::include_graphics("Tutorial_hstm_1_files/images/Image_hint.png")
```

```{r, fig.align = 'center', out.width = "70%", echo = F}
knitr::include_graphics("Tutorial_hstm_1_files/images/Image_solution.png")
```

### Prerequisites
You should be able to following commands to perform this exercise:  

- `matrix()` function  


## Model structure & parameters

### Model structure
This section provides an explaination of the health state transition model (HSTM) used in this practical assignment. The HSTM represents the disease progression and treatment of patients who may develop an aneurysm. All patients start in the "Healthy" health state. From there, they can die from other causes of disease than an aneurysm, or they can develop a new intracranial aneurysm.  If they develop an aneurysm, the aneurysm can be detected, or they can die. If the aneurysm is detected, it is assumed that patients receive treatment. The treatment can either be succesful and the patients return to "Healthy", or the treatment can be fatal and patients die. When patients die (from any causes), they remain in that health state ('dead' is an absorbing health state).  
In this model, patients move as an homogeneous cohort, all individuals start in the "Healthy" health state, the time cycle (or cycle length) in this model is **1 month**. Costs and health effects are not included in this simple model.  
In the following exercises, the health states are called as follows:

- "Healthy" = "Healthy"  
- "Death due to other causes" = "DeathOther"  
- "A new intracranial aneurysm is detected" = "NewAneurysm"  
- "Detected unruptured intracranial aneurysm" = "DetectedAneurysm"  
- "Death due to aneurysm treatment"= "DeathTreatment"  
  
```{r, fig.align = 'center', out.width = "90%", echo = F}
knitr::include_graphics("Tutorial_hstm_1_files/images/Fig_model_structure.png")
```

### Probabilities
The probabilities below describe which proportion of the cohort transit from one health state to another per cycle. For instance, `p_NewAneurysm`, the probability that an individual develops a new intracranial aneurysm, means that 10% of individuals in the "Healthy" health state, will transit from "Healthy" to "A new intracranial aneurysm is present".  

```{r probs, echo = TRUE}
p_NewAneurysm       <- 	0.10 # Probability that an individual develops a new intracranial aneurysm 
p_AneurysmDetection <- 	0.50 # Probability that a newly developed aneurysm is detected
p_TreatmentIsFatal  <- 	0.20 # Probability that treatment of a detected aneurysm induces a fatal complication
p_DeathOther        <- 	0.10 # Probability of death due to causes unrelated to aneurysms
```


### Questions
Use these transition probabilities and the model structure to calculate the following probabilities/quantities (subquestions a to j). For your convenience, the probabilities have been loaded.    

a. The probability than an individual dies from aneurysm treatment in month 2  

```{r 1a, exercise = TRUE}
 
```

```{r 1a-solution}
 
```

b. The probability that an individual starts in the "Healthy" state and remains there, that is, survives and does not develop an aneurysm, in 1 year  

```{r 1b, exercise = TRUE}
 
```

```{r 1b-solution}
(1 - p_NewAneurysm - p_DeathOther) ^ 12
```

c. The probability that an individual develops 2 aneurysms and is treated successfully twice (starting health state for this calculation is "Healthy")  

```{r 1c, exercise = TRUE}

```

```{r 1c-solution}
(p_NewAneurysm * p_AneurysmDetection * (1 - p_TreatmentIsFatal)) ^ 2
# OR: (p_NewAneurysm * p_AneurysmDetection * (1 - p_TreatmentIsFatal)) * (p_NewAneurysm * p_AneurysmDetection * (1 - p_TreatmentIsFatal))
```

d. The probability that an individual dies of other causes within the first month  

```{r 1d, exercise = TRUE}

```

```{r 1d-solution}
p_DeathOther
```

e. The probability that an individual dies of other causes within the first 2 months  

```{r 1e, exercise = TRUE}

```

```{r 1e-solution}
p_DeathOther + p_DeathOther * (1 - p_DeathOther - p_NewAneurysm) + p_DeathOther * p_NewAneurysm
```


f. The probability that an individual with a new and untreated aneurysm (that remains untreated) develops an additional, new aneurysm, in 2 yearsâ€™ time  

```{r 1f, exercise = TRUE}

```

```{r 1f-solution}
0
```

g. The excess mortality risk (expressed as relative risk) of individuals with successfully treated aneurysms compared to healthy individuals  

```{r 1g, exercise = TRUE}

```

```{r 1g-solution}
1
```

h. The risk of death from a car accident for an individual with a detected unruptured aneurysm  

```{r 1h, exercise = TRUE}

```

```{r 1h-solution}
0
```

i. [OPTIONAL] The sensitivity of the (unknown) test used to detect aneurysms after 4 months/repetitions  

```{r 1i, exercise = TRUE}

```

```{r 1i-solution}
p_AneurysmDetection + p_AneurysmDetection * (1 - p_AneurysmDetection - p_DeathOther) +
  p_AneurysmDetection * (1 - p_AneurysmDetection - p_DeathOther) ^ 2 +
  p_AneurysmDetection * (1 - p_AneurysmDetection - p_DeathOther) ^ 3
```

j. [OPTIONAL] The probability that an individual with a new aneurysm dies before it is detected (you can give an approximation, or the exact value)  

```{r 1j, exercise = TRUE}

```

```{r 1j-solution}
# Approximation
sum((p_DeathOther) * (1 - p_DeathOther - p_AneurysmDetection) ^ c(0:1000)) # limit, the number 1000 can be increased if needed
```

### Explanations
a. It is not possible to reach the "DeathTreatment" state in 2 cycles because individuals have to develop the aneurysm, the aneurysm has to be detected, and then be treated to be fatal.  
b. Survival without new aneurysm has probability 0.8 per cycle. This probability is multiplied 12 times by itself because the cycle length is 1 month.  
c. This is calculated as the probability of new anerism x probability it is detected * probability it is sucessfully treated. This has to be exponentiated by because this process should occur twice in a row to answer this question.  
d. This is just the probability of dying from other causes (`p_DeathOther` or 10%)  
e. This is calculated as the probability of Death from Healthy in cycle 1 (`p_DeathOther`) plus the probability of remaining health and dying from other causes in cycle 2 (`p_DeathOther` * (1 - `p_DeathOther` - `p_NewAneurysm`)) plus death from a new aneurysm in cycle 2 (`p_DeathOther` * `p_NewAneurysm`).  
f. In this health economic model, it is not possible to have more than 1 untreated aneurysm. This cannot be calculated based on this model.  
g. Given they survive treatment, all treated individuals will return to the "Healthy" health state in the cycle following treatment. This Markov model has no 'memory': all individuals in a health state are similar, regardless of their history. Consequently, having survived aneurysm treatment does not affect the survival of individuals once they have transited to the "Healthy" health state.    
h. Due to the severity of aneurysm treatment death from other causes is ignored in the cycle patients are treated.  
i. Every cycle, there is 50% probability of detection of the aneurysm in individuals with an aneurysm who are still alive and without previous detection. Hence, for each cycle, the probability of staying in the "NewAneurysm" health state is 40% (calculated as 1 - `p_AneurysmDetection` - `p_DeathOther`) and is multiplied by the probability of detecting the aneurysm (50% or 0.5, `p_AneurysmDetection`).  
j. The approximation for 2, 3, 4 cycles is 0.140, 0.156, 0.162 respectively, the true value (limit) equals 1/6 = 0.166. See http://www.mathsisfun.com/algebra/sequences-sums-geometric.html for a more extensive explanation. Here we have `a` = 1/10 (`p_DeathOther` = 10% or 0.1 )and `r` = 2/5 (1 - `p_AneurysmDetection` - `p_DeathOther` = 60% or 0.6) so the sum of our geometric series converges to `a`\*(1/(1-`r`)) = 1/10\*(1/(1 - 2/5)) = 1/6. The demonstration is provided in the graph below.  

```{r plot_1j}
plot(y = cumsum((p_DeathOther) * (1 - p_DeathOther - p_AneurysmDetection) ^ c(0:1000)), 
     x = log(c(0:1000)),
     type = "l",
     main = "Convergence probability to die before the aneurysm is detected",
     xlab = "Number of cycles (log scale)",
     xaxt = "n",
     ylab = "Probability") # graphic of the solution (x on the log scale)
axis(1, at = c(log(1), log(10), log(20), log(50), log(100), log(500), log(1000)), 
     labels = c(1, 10, 20, 50, 100, 500, 1000)
     )
```

## Transition matrix
Defining the transition matrix based on the transition probabilities described in the previous step, is the first step to define the life course of the cohort of individuals in this model. Defining the life course of the cohort is done by multiplying the number of patients in each health state by the probabilities which affect the state membership of that health state. We will do this in several steps:

- Step 1: Defining the transition matrix for the cohort simulation  
- Step 2: Defining the cohort simulation matrix  
- Step 3: Filling in the cohort simulation matrix using the transition matrix and the starting position of individuals  

Steps 2 & 3 will be performed under the "Cohort simulation" tab.  

### Defining the transition matrix  
To evaluate the life course of individuals over a large number of time cycles we need a transition matrix. Create a transition matrix called `m_tp`. `m_tp` should contain 5 rows and 5 columns because we have 5 health state ("Healthy", "NewAneurysm",	"DetectedAneurysm", "DeathOther",	"DeathTreatment"). To do so, use the `matrix()` function. Assign the value NA or 0 to all cells of the matrix to start with. Name the rows and columns (`dimnames` argument of the function) with the following names: "Healthy", "NewAneurysm",	"DetectedAneurysm", "DeathOther",	"DeathTreatment". You can also create a vector with these names, `v_names_hs`, that you then use within the `dimnames` argument.    

```{r trans_mat, exercise = TRUE}

```

```{r trans_mat-solution}
v_names_hs <- c("Healthy", "NewAneurysm",	"DetectedAneurysm", "DeathOther",	"DeathTreatment")
n_hs <- length(v_names_hs) # this equals 5

m_tp <- matrix(0, 
               ncol = n_hs, # or 5
               nrow = n_hs, # or 5
               dimnames = list(v_names_hs,
                               v_names_hs)
               )
#data.frame(m_tp) # show, data.frame() used because prettier
```

### Filling the transition matrix with transition probabilities
Fill the matrix with the values of the transition probabilities. The rows indicate the health state from which persons transit. The columns indicate the health state to which persons transit. You can use the names of the rows and columns to assign the transition probabilities to each cell. Do not forget to define the probability of remaining in a health state!  

```{r fill_trans_mat, exercise = TRUE, exercise.setup = "trans_mat-solution"}

```

```{r fill_trans_mat-hint}
m_tp["Healthy", "Healthy"]     <- 1- p_NewAneurysm - p_DeathOther # Example: probability of remaining healthy when healthy
```

```{r fill_trans_mat-solution}
m_tp["Healthy", "Healthy"]     <- 1- p_NewAneurysm - p_DeathOther
m_tp["Healthy", "DeathOther"]  <- p_DeathOther
m_tp["Healthy", "NewAneurysm"] <- p_NewAneurysm
m_tp["NewAneurysm", "DetectedAneurysm"] <- p_AneurysmDetection
m_tp["NewAneurysm", "DeathOther"] <- p_DeathOther
m_tp["NewAneurysm", "NewAneurysm"] <- 1 - p_AneurysmDetection - p_DeathOther
m_tp["DetectedAneurysm", "Healthy"] <- 1 - p_TreatmentIsFatal
m_tp["DetectedAneurysm", "DeathTreatment"] <- p_TreatmentIsFatal
m_tp["DeathOther", "DeathOther"] <- 1
m_tp["DeathTreatment", "DeathTreatment"] <- 1

#data.frame(m_tp) # show, data.frame() used because prettier
```

### Check
```{r trans_mat_setup}
m_tp <- determine_m_tp()
```

Check whether all rows sum up to one.  
```{r check_trans_mat, exercise = TRUE, exercise.setup = "trans_mat_setup"}

```

```{r check_trans_mat-hint}
"Use the rowSums() function"
```

```{r check_trans_mat-solution}
rowSums(m_tp) == 1 # all true!
```

## Transition matrix - illustration
This part of the assignment illustrates the functioning of the transition matrix. Fill in the transition probabilities that you have used to define your transition matrix. The transition matrices are then automatically filled in based on your inputs. The transition matrices to calculate the health state distribution after 2, 3, or N cycles is obtained by multiplying the transition matrix by itself 2, 3, and N times respectively. The health state distribution after 2, 3, and N cycles is obtained by multiplying these transition matrices by the starting health state distribution The resulting health state memberships (after 1, 2,3 and N cycles), given all patients start in the "Healthy" health state, are provided in the tables titled "Health state distribution after 1, 2, 3, N cycles".   
Answer the questions below using this information, and by changing the number of cycles and the proportion of individuals starting in each health state.  
**OF NOTE**: Probabilities and proportions should be written in decimals, example: 20% should be 0.2).  

```{r shiny_m_tp}
h2("Inputs")
h3("Transition probabilities")
div(style="display:inline-block",
numericInput(inputId = "p_NewAneurysm",
             label = "Probability of new aneurysm",
             value = 0,
             min = 0,
             max = 1,
             width = "175px")
)
div(style="display:inline-block",
numericInput(inputId = "p_AneurysmDetection",
             label = "Probability aneurysm is detected",
             value = 0,
             min = 0,
             max = 1,
             width = "175px")
)
div(style="display:inline-block",
numericInput(inputId = "p_TreatmentIsFatal",
             label = "Probability aneurysm's treatment is fatal",
             value = 0,
             min = 0,
             max = 1,
             width = "175px")
)
div(style="display:inline-block",
numericInput(inputId = "p_DeathOther",
             label = "Probability of death from other causes",
             value = 0,
             min = 0,
             max = 1,
             width = "175px")
)
tags$hr()
h3("Cycle at which health state membership has to be defined")
numericInput(inputId = "n_cycle",
            label = "Health state membership after:",
            value = 2,
            min = 2,
            max = 100,
            width = "175px")
tags$hr()
h3("Health state membership at start")
div(style="display:inline-block",
numericInput(inputId = "n_Healthy",
             label = "Proportion of individuals starting in health state: 'Healthy'",
             value = 1,
             min = 0,
             max = 1,
             width = "175px")
)
div(style="display:inline-block",
numericInput(inputId = "n_NewAneurysm",
            label = "Proportion of individuals starting in health state: 'New aneurysm'",
            value = 0,
            min = 0,
            max = 1,
            width = "175px")
)
div(style="display:inline-block",
numericInput(inputId = "n_AneurysmDetection",
            label = "Proportion of individuals starting in health state: 'Aneurysm detected'",
            value = 0,
            min = 0,
            max = 1,
            width = "175px")
)
tags$hr()
h2("Outputs")
h3("Transition matrix after 1 cycle")
tableOutput("m_tp_1")
h3("Health state distribution after 1 cycle")
tableOutput("t_dist_1")
tags$hr()
h3("Transition matrix after 2 cycles")
tableOutput("m_tp_2")
h3("Health state distribution after 2 cycles")
tableOutput("t_dist_2")
tags$hr()
h3("Transition matrix after 3 cycles")
tableOutput("m_tp_3")
h3("Health state distribution after 3 cycles")
tableOutput("t_dist_3")
tags$hr()
h3(textOutput("txt_m_tp_n"))
tableOutput("m_tp_n")
h3(textOutput("txt_dist_tp_n"))
tableOutput("t_dist_n")
```

```{r shiny_m_tp_server, context = "server"}
mat_tp <- function() {
  v_names_hs <- c("Healthy", "NewAneurysm",	"DetectedAneurysm", "DeathOther",	"DeathTreatment")
  m_tp <- matrix(0, 
               ncol = 5,
               nrow = 5,
               dimnames = list(v_names_hs,
                               v_names_hs))

  m_tp["Healthy", "Healthy"]     <- 1- input$p_NewAneurysm - input$p_DeathOther # Example
  m_tp["Healthy", "DeathOther"]  <- input$p_DeathOther
  m_tp["Healthy", "NewAneurysm"] <- input$p_NewAneurysm
  m_tp["NewAneurysm", "DetectedAneurysm"] <- input$p_AneurysmDetection
  m_tp["NewAneurysm", "DeathOther"] <- input$p_DeathOther
  m_tp["NewAneurysm", "NewAneurysm"] <- 1 - input$p_AneurysmDetection - input$p_DeathOther
  m_tp["DetectedAneurysm", "Healthy"] <- 1 - input$p_TreatmentIsFatal
  m_tp["DetectedAneurysm", "DeathTreatment"] <- input$p_TreatmentIsFatal
  m_tp["DeathOther", "DeathOther"] <- 1
  m_tp["DeathTreatment", "DeathTreatment"] <- 1

  return(m_tp)
  }

v_start <- function() {c(input$n_Healthy,
                         input$n_NewAneurysm,
                         input$n_AneurysmDetection,
                         0,
                         0)}

output$m_tp_1 <- renderTable({
  cbind(` `=colnames(mat_tp()), mat_tp())
  
})

output$t_dist_1 <- renderTable({
  v_start() %*% mat_tp() 
})

output$m_tp_2 <- renderTable({
  m_tp_2 <- mat_tp() %*% mat_tp() 
  
  cbind(` `=colnames(mat_tp()), m_tp_2)
})

output$t_dist_2 <- renderTable({
  v_start() %*% (mat_tp() %*% mat_tp())
})

output$m_tp_3 <- renderTable({
  m_tp_3 <- (mat_tp() %*% mat_tp() %*% mat_tp()) 
  
  cbind(` `=colnames(mat_tp()), m_tp_3)
})

output$t_dist_3 <- renderTable({
  v_start() %*% (mat_tp() %*% mat_tp() %*% mat_tp())
})

output$m_tp_n <- renderTable({
  
  for (i in 2:input$n_cycle) {
    if(i == 2) {
      m_tp_n <- mat_tp() %*% mat_tp()
    } else {
      m_tp_n <- m_tp_n %*% mat_tp()
    }
  }
  
  cbind(` `= colnames(mat_tp()), round(m_tp_n,3))
})

output$t_dist_n <- renderTable({
  
  for (i in 2:input$n_cycle) {
    if(i == 2) {
      m_tp_n <- mat_tp() %*% mat_tp()
    } else {
      m_tp_n <- m_tp_n %*% mat_tp()
    }
  }
  
  v_start() %*% m_tp_n
}, digits = 3)

output$txt_m_tp_n <- renderText({
  paste("Transition matrix after", input$n_cycle ,"cycles", sep = " ")
})

output$txt_dist_tp_n <- renderText({
  paste("Health state distribution after", input$n_cycle ,"cycles", sep = " ")
})
```

### Questions
a. What is the probability that an individual is healthy after exactly 1 year?  

```{r 2a}
textInput("Answer_a", "Type your answer")
```

b. Compare the previous answer with the answer of question b. under the "Model structure & parameters"-tab. Why is the probability above larger than the answer of question b. under the "Model structure & parameters"-tab?  

```{r 2b}
textInput("Answer_b", "Type your answer")
```

c. How many months does it take until 60% of all individuals have died?  

```{r 2c}
textInput("Answer_c", "Type your answer")
```

d. What percentage of all individuals is still alive after 2 years?  

```{r 2d}
textInput("Answer_d", "Type your answer")
```

e. How much more likely are individuals to die from other causes than from aneurysm treatment? Hint: this only becomes apparent when all individuals have died.  

```{r 2e}
textInput("Answer_e", "Type your answer")
```

f. Change the starting state membership of the model (using the input fields) to reflect 50% individuals starting in the "New Aneurysm" state and 50% starting in the "Detected Aneurysm" state. How does this change the probability of an individual being healthy after exactly 1 year? Compare your answer to the answer of question a.  

```{r 2f}
textInput("Answer_f", "Type your answer")
```

g. Why doesnâ€™t the distribution of individuals over the health states change when you apply a time horizon of 7 years instead of 6 years?  

```{r 2g}
textInput("Answer_g", "Type your answer")
```

### Answers
a. 19.5% (0.195). To obtain this answer, the number of cycle should be set to 12.  

b. The 0.195 from question a. also includes all individuals who develop an aneurysm which is then succesfully treated, while this is not taken into account answer b. of the previous assignment.  

c. 8 cycles. For N = 8 we find approximately 52% of individuals have died from other causes and 6% from treatment, which makes a total of ~ 60%  

d. 4.9% in the "Healthy" health state, 1% in the "New Aneurysm" health state, and 0.6% in the "Detected Aneurysm" health state, which is a total of 6.5%.  

e. After any number of cycles > 65, everybody has died and we can answer this question: 87.5% of individuals have died from other causes, and 12.5% have died from treatment. This results in a relative risk of 0.875/0.125 = 7.  

f. The probability of being health after a year is now 17.7%, which is lower than the 19.5% of answer a. This is a reduction of 1.8% in absolute term, and a decrease of 9.2% in relative terms.  
g. 7 years means N = 12\*7 = 84, and 6 years means N = 12\*6 = 72. From testing different values of N we find that the distribution of individuals over the 5 health states does not change anymore (at least in 3 decimals) for N > 65. Indeed, for any time horizon longer than 65 months we will find the same results as all individuals will die within 65 months time.  

## Cohort simulation
This part of the assignment focuses on defining the life course of the cohort of individuals included in the health economic model. We perform this by modelling the disease progression of individuals through the cohort simulation using the matrix (`m_tp`) defined under the "Transition matrix"-tab. The method used to perform these calculations are described extensively in [Alarid Escudero et al. 2021](https://arxiv.org/abs/2001.07824). In this part of the tutorial, we focus on steps 2 and 3 of this sequence:  

- Step 1: Defining the transition matrix for the cohort simulation  
- Step 2: Defining the cohort simulation matrix  
- Step 3: Filling in the cohort simulation matrix using the transition matrix and the starting position of individuals

Remember the transition probabilities and transition matrix we have defined earlier.  
```{r, echo = T}
# Probabilities
p_NewAneurysm  	    <- 0.10 # Probability that an individual develops a new intracranial aneurysm 
p_AneurysmDetection <- 0.50 # Probability that a newly developed aneurysm is detected
p_TreatmentIsFatal  <- 0.20 # Probability that treatment of a detected aneurysm induces a fatal complication
p_DeathOther  	    <- 0.10 # Probability of death due to causes unrelated to aneurysms

# Defining transition matrix
v_names_hs <- c("Healthy", "NewAneurysm",	"DetectedAneurysm", "DeathOther",	"DeathTreatment")
m_tp <- matrix(0, 
               ncol = length(v_names_hs),
               nrow = length(v_names_hs),
               dimnames = list(from = v_names_hs,
                               to = v_names_hs))

m_tp["Healthy", "Healthy"]     <- 1- p_NewAneurysm - p_DeathOther
m_tp["Healthy", "DeathOther"]  <- p_DeathOther
m_tp["Healthy", "NewAneurysm"] <- p_NewAneurysm
m_tp["NewAneurysm", "DetectedAneurysm"] <- p_AneurysmDetection
m_tp["NewAneurysm", "DeathOther"] <- p_DeathOther
m_tp["NewAneurysm", "NewAneurysm"] <- 1 - p_AneurysmDetection - p_DeathOther
m_tp["DetectedAneurysm", "Healthy"] <- 1 - p_TreatmentIsFatal
m_tp["DetectedAneurysm", "DeathTreatment"] <- p_TreatmentIsFatal
m_tp["DeathOther", "DeathOther"] <- 1
m_tp["DeathTreatment", "DeathTreatment"] <- 1

data.frame(m_tp)
```

