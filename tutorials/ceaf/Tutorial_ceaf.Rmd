---
title: "Tutorial discounting"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include = FALSE}
require(learnr, quietly = TRUE)
require(knitr, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(shiny, quietly = TRUE)
load("Tutorial_ceaf_files/R/question_numeric.R")

knitr::opts_chunk$set(echo = FALSE)

df_thx <- as.data.frame(cbind(
  Strategy = c(1:9),
  Name = c("No screening (REF)",  
           "Screening once, at age 40",
           "Screening once, at age 60",  
           "Screening once, at age 80",
           "Screening twice, at age 40 and 60",  
           "Screening every 10 years from age 40 to 80",
           "Screening every 10 years from age 50 to 80",
           "Screening every 5 years from age 40 to 80",
           "Screening every 5 years from age 50 to 80"),
  Costs = c(0, 23500, 12500, 14000, 36000, 67500, 57500, 113000,  88000),
  QALYs = c(0.0, 1.1, 0.9, -0.5, 1.9, 3.3, 3.2, 4.1, 4.0)
))

df_thx[, c("Costs", "QALYs")] <- apply(df_thx[, c("Costs", "QALYs")], 2, function(x) as.numeric(as.character(x)))
df_thx[, "Strategy"] <- as.factor(as.character(df_thx[, "Strategy"]))
```


## Discounting

### Before starting
Watch the video explaining the cost-effectiveness acceptability frontier (to do so, you probably need to open open the tutorial in your browser using the 'Open in Browser' button on the upper left side of the screen.  
![](https://vimeo.com/453418692/629173c450){width="70%"}
Link to the video: https://vimeo.com/453418692/629173c450

### Aims and instructions
This assignment aims to familiarise you with the concept of the cost-effectiveness acceptability frontier (CEAF), by constructing one yourself, based on a fictive example. The aim of this assignment is to identify which of the following screening strategy is the most cost effective.  
**OF NOTE**: the solutions which are provided are one way to perform the calculations, you can obtain the same results using other fomula's. The last 'Hint' is always the solution of the assignment. Soultions can be copy/paste in the chunk as shown in the . Once you have completed a code chunk, you can run it by pushing the 'Run code' button on the upper-right side of the chunk.    

```{r, fig.align = 'center', out.width = "70%", echo = F}
knitr::include_graphics("Tutorial_ceaf_files/images/Image_hint.png")
```

```{r, fig.align = 'center', out.width = "70%", echo = F}
knitr::include_graphics("Tutorial_ceaf_files/images/Image_solution.png")
```

[Link to figures](https://education.rstudio.com/blog/2020/05/learnr-for-remote/)

### The data
The assignment uses the `df_thx` object, which is already loaded in this tutorial. 

The `df_thx` object contains 4 variables and 9 observations (the outcomes of the strategies to compare):  

- Strategy = the number identifying the screening strategy  
- Name = the name of the screening strategy  
- Costs = the total costs of the screening strategy    
- QALYs = the total QALYs gained through the screening strategy 

The `df_thx` object is displayed herebelow. Have a look at this data.frame and before starting the assignment.

```{r show_data}
df_thx

ggplot(data = df_thx, aes(x = QALYs, Costs, colour = Strategy)) +
  geom_point() + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey") +
  ggtitle("Cost-effectiveness plane") +
  theme_bw()
```


```{r quiz_start}
quiz(
question("Based on this graph, can you already tell which strategy is dominated",
  answer("Strategy 1", correct = TRUE),
  answer("Strategy 2", correct = TRUE),
  answer("Strategy 3", correct = TRUE),
  answer("Strategy 4", correct = TRUE),
  answer("Strategy 5", correct = TRUE),
  answer("Strategy 6", correct = TRUE),
  answer("Strategy 7", correct = TRUE),
  answer("Strategy 8", correct = TRUE),
  answer("Strategy 9", correct = TRUE),
  answer("None", correct = TRUE),
  type = "learnr_radio",
  correct = "Let's have a look whether you guessed it right by performing the assignment!"
),
question("Based on this graph, can you already tell which strategy is extendedly dominated?",
  answer("Strategy 1", correct = TRUE),
  answer("Strategy 2", correct = TRUE),
  answer("Strategy 3", correct = TRUE),
  answer("Strategy 4", correct = TRUE),
  answer("Strategy 5", correct = TRUE),
  answer("Strategy 6", correct = TRUE),
  answer("Strategy 7", correct = TRUE),
  answer("Strategy 8", correct = TRUE),
  answer("Strategy 9", correct = TRUE),
  answer("None", correct = TRUE),
  type = "learnr_radio",
  correct = "Let's have a look whether you guessed it right by performing the assignment!"
)
)
```

### Assignment and questions
Calculate the fully incremental ICERs of these screening strategies against each other and answer the questions below.     
**To do so, you can use a pen, paper, and calculator and use the method described in the paper from Paulden (literature list) OR you can follow this tutorial. The answers to these questions are at the end of this tutorial.**  
1. Which strategies are dominated?  
2. Which strategies are extendedly dominated?  
3. Which strategies are on the cost-effectiveness acceptability frontier?  
4. Which strategy is optimal if the WTP threshold is equal to €20,000/QALY?  
5. Which strategy is optimal if the WTP threshold is equal to €40,000/QALY?  
6. Which strategy is optimal if the WTP threshold is equal to €100,000/QALY?  
7. At which WTP threshold would strategy 4 be the optimal strategy?  
8. At which WTP threshold would strategy 7 be the optimal strategy?  
9.	Calculate the Net Monetary Benefit (NMB) for each strategy for a WTP threshold of €20,000/QALY. Which strategy has the highest NMB? Does this correspond with your answer to question 4?  

### Step 1: order the strategies by increasing total QALYs
```{r order, echo = TRUE}
df_thx <- df_thx[order(df_thx$QALYs),]
df_thx
```

### Step 2: identify the dominated strategies
```{r quiz_dominated}
question("Based on the table where strategies are ordered by incresing total number of QALYs, which strategy is dominated?",
  answer("Strategy 1"),
  answer("Strategy 2"),
  answer("Strategy 3"),
  answer("Strategy 4", correct = TRUE),
  answer("Strategy 5"),
  answer("Strategy 6"),
  answer("Strategy 7"),
  answer("Strategy 8"),
  answer("Strategy 9"),
  answer("None")
)
```

Can you explain why this (these) strategy(ies) are dominated
```{r, echo = FALSE}
textInput("Answer_1", "Enter your answer")
```

### Explanation answer Step 2
Strategy 4 is dominated by Strategy 1 because Strategy 1 provides more health benefits (QALYs) at a lower costs.  

### Step 3: Calculate ICERs
Since strategy 4 is dominated, it will not be used further in the comparison of the strategies. It is now time to calculate the different ICERs.
```{r}
df_thx <- df_thx[order(df_thx$QALYs),]
rownames(df_thx) <- NULL
df_thx[which(df_thx$Strategy !=4), ]
```

Calculate the ICERs of strategies 3, 2, 5, 7, 6, 9, 8. You can use a calculator or the R code chunk below to calculate them. Round your results to the closest euro. Check your answers in the quiz!

```{r calc_icers_1, exercise = TRUE}

```

```{r calc_icers_1-solution}
# EXAMPLE: ICER of 3 versus 1
diff_costs <- df_thx[which(df_thx$Strategy == 3), "Costs"] - df_thx[which(df_thx$Strategy == 1), "Costs"] # difference in costs between strategy 3 and 1
diff_effects <- df_thx[which(df_thx$Strategy == 3), "QALYs"] - df_thx[which(df_thx$Strategy == 1), "QALYs"] # difference in effects between strategy 3 and 1

icer <- diff_costs / diff_effects # ratio of the difference in costs by the difference in effect
icer_rounded <- round(icer) # rounding off
icer_rounded # shows results
```



```{r calc_icer1, echo = FALSE}
numericInput("icer_3", "ICER strategy 3", min = -Inf, max = Inf, value = 0)
numericInput("icer_2", "ICER strategy 2", min = -Inf, max = Inf, value = 0)
numericInput("icer_5", "ICER strategy 5", min = -Inf, max = Inf, value = 0)
numericInput("icer_7", "ICER strategy 7", min = -Inf, max = Inf, value = 0)
numericInput("icer_6", "ICER strategy 6", min = -Inf, max = Inf, value = 0)
numericInput("icer_9", "ICER strategy 9", min = -Inf, max = Inf, value = 0)
numericInput("icer_8", "ICER strategy 8", min = -Inf, max = Inf, value = 0)
actionButton(inputId = "check_res_icer1",
             label = "Push to check your results!")
```

```{r quiz_icers1}
question_numeric("What is the ICER of strategy 3?",
              answer(13889, correct = TRUE),
              allow_retry = TRUE
     )

# question_numeric("What is the ICER of strategy 2?",
#          answer(55000, correct = TRUE),
#          allow_retry = TRUE)
# question_numeric("What is the ICER of strategy 5?",
#          answer(15625, correct = TRUE),
#          allow_retry = TRUE)
# question_numeric("What is the ICER of strategy 7?",
#          answer(16538, correct = TRUE),
#          allow_retry = TRUE)
# question_numeric("What is the ICER of strategy 6?",
#          answer(100000, correct = TRUE),
#          allow_retry = TRUE)
# question_numeric("What is the ICER of strategy 9?",
#          answer(29286, correct = TRUE),
#          allow_retry = TRUE)
# question_numeric("What is the ICER of strategy 8?",
#          answer(250000, correct = TRUE),
#          allow_retry = TRUE)


```

```{r, echo = FALSE}
v_icer1_check <- eventReactive(input$check_res_icer1, {
  res_1 <- as.character(ifelse(input$icer_3 == 13889, "Correct", "Try again"))
  res_2 <- as.character(ifelse(input$icer_2 == 55000, "Correct", "Try again"))
  res_5 <- as.character(ifelse(input$icer_5 == 15625, "Correct", "Try again"))
  res_7 <- as.character(ifelse(input$icer_7 == 16538, "Correct", "Try again"))
  res_6 <- as.character(ifelse(input$icer_6 == 100000, "Correct", "Try again"))
  res_9 <- as.character(ifelse(input$icer_9 == 29286, "Correct", "Try again"))
  res_8 <- as.character(ifelse(input$icer_8 == 250000, "Correct", "Try again"))
  
  v_res <- c(res_1, res_2, res_5, res_7, res_6, res_9, res_8)
  return(v_res)
}
)

```
**THE END**
