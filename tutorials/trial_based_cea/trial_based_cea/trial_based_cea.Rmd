---
title: "Tutorial trial-based CEA"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include = FALSE}
require(learnr, quietly = TRUE)
require(knitr, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(shiny, quietly = TRUE)
require(boot, quietly = TRUE)
require(dplyr, quietly = TRUE)

knitr::opts_chunk$set(echo = FALSE)

df <- data.frame(cbind(
  ID         = rep(1:100, 2),
  Procedure  = c(rep(1, 100), rep(2, 100)),
  OR_time    = c(rnorm(100, 140, 10), rnorm(100, 120, 20)),
  Major_compl = c(ifelse(runif(100) <= 0.25, 1, 0), ifelse(runif(100) <= 0.12, 1, 0)),
  Minor_compl = c(ifelse(runif(100) <= 0.35, 1, 0), ifelse(runif(100) <= 0.5, 1, 0)),
  Length_icu = c(ifelse(runif(100) <= 0.7, 0, rpois(100, 5)), ifelse(runif(100) <= 0.7, 0, rpois(100, 4))),
  Length_mcu = c(rpois(100, 14), rpois(100, 15)),
  Death      = c(ifelse(runif(100) <= 0.15, 1, 0), ifelse(runif(100) <= 0.10, 1, 0)),
  Qol = c(rbeta(100, 0.5, 0.5), rbeta(100, 0.6, 0.5))
)
)
df$Qol <- ifelse(df$Death == 1, 0, df$Qol)

# Declare inputs of the analysis
c_Robot <- 3000 
c_Open <- 2000 
c_OK_hour <- 500 
c_Major_compl <- 10000 
c_Minor_compl <- 1500 
c_ICU_day <- 1250 
c_MCU_day <- 550 
```


## Trial-based CEA

### Before starting
1. Watch the video explaining the difference between trial-based and m0del-based economic cost-effectiveness analyses (CEA) (to do so, you probably need to open open the tutorial in your browser using the 'Open in Browser' button on the upper left side of the screen.  
![](https://vimeo.com/453418735/b3dfb1f3e4){width="70%"}
Link to the video: https://vimeo.com/453418735/b3dfb1f3e4.  

### Aims and instructions
The aim of this practical assignment is to perform a health economic analysis using data collected during a clinical trials. The data used in this assignment was obtained during a randomised controlled trial (RCT) comparing two interventions for treating esophageal cancer. In total, 200 patients were randomized between usual care (open transthoracic esophagectomy) and the new intervention (robot-assisted thoraco-laparoscopic esophagectomy). For each patient, data was collected on the time required for the procedure in the operating room, the occurrence of complications, the length of stay in the hospital, and the quality of life after the procedure. In addition, data on the cost of resources was collected from the literature.  
**OF NOTE**: the solutions which are provided are one way to perform the calculations, you can obtain the same results using other fomula's. The last 'Hint' is always the solution of the assignment. Soultions can be copy/paste in the chunk as shown in the figures below. Once you have completed a code chunk, you can run it by pushing the 'Run code' button on the upper-right side of the chunk.  

### Required knowledge
To perform this assignment, you should be able to:  

- create new variables in a dataframe  
- use the functions `group_by` and `summarise` (`dyplr` package)   
- use functions: `mean()`, `sum()`, `ifelse()` (base R)  


### Objects of this practical
Different objects have already been loaded in R's memory to perform this practical assignment.  

A dataframe `df`. This dataframe contains 9 variables, each row of the dataframe contains the outcomes from one participant:  

- `ID` = Participant ID  
- `Procedure`  = Group to which the participant belongs; 1 = usual care (open transthoracic esophagectomy), 2 = the new intervention (robot-assisted thoraco-laparoscopic esophagectomy)  
- `OR_time` = Operating time, in minutes  
- `Major_compl` = 'Did the participant experience a major complication?'; 1 = yes, 0 = no  
- `Minor_compl` = 'Did the participant experience a minor complication?'; 1 = yes, 0 = no  
- `Length_icu` = Length of stay at the intensive care unit (ICU) in days  
- `Length_mcu` = Length of stay at the intensive care unit (MCU) in days  
- `Death`      = 'Did the participant experience die at the hospital?'; 1 = yes, 0 = no   
- `Qol` = Quality of life of the participant after the procedure  

The following tables show the dataframe `df`. Familiarise yourself with it.  

```{r show_df}
df
```


Other objects, which represent the costs of the surgeries, hospital days, adverse events, and hourly costs of using the operating room:  

- `c_Open` =  costs of the open transthoracic esophagectomy (usual care)  
- `c_Robot` = costs of the robot-assisted thoraco-laparoscopic esophagesctomy (new intervention)  
- `c_ICU_day` = costs of one day at the ICU  
- `c_MCU_day` = costs of one day at the MCU  
- `c_Major_compl` = costs of a major complication  
- `c_Minor_compl` = costs of a minor complication  
- `c_OK_hour` = costs of operating in the OK, per hour

### Assignment 1
Calculate the mean operating time, risk of complications, length of stay at ICU and MCU, risk of death, and quality of life after procedure, for both trial arms.    

```{r mean_eff, exercise = TRUE}

```

```{r mean_eff-hint}
"Use the combination of functions `group_by()` (dplyr package), `summarise()` (dplyr package), `mean()` (base R) to do so."
```

```{r mean_eff-solution}
df %>%
  group_by(Procedure) %>% # grouping per Procedure
  summarise(mean_OR_time = mean(OR_time),
            mean_Major_compl = mean(Major_compl),
            mean_Minor_compl = mean(Minor_compl),
            mean_Length_icu  = mean(Length_icu),
            mean_Length_mcu  = mean(Length_mcu),
            mean_p_death = mean(Death),
            mean_Qol = mean(Qol)) # Mean calculations
```

### Assignment 1 - questions
The correct answer are provided below. Use these results to check your answers and answer the questions below.  

```{r}
round(df %>%
  group_by(Procedure) %>% # grouping per Procedure
  summarise(mean_OR_time = mean(OR_time),
            mean_Major_compl = mean(Major_compl),
            mean_Minor_compl = mean(Minor_compl),
            mean_Length_icu  = mean(Length_icu),
            mean_Length_mcu  = mean(Length_mcu),
            mean_p_death = mean(Death),
            mean_Qol = mean(Qol)
            ), # Mean calculations
  2)

```

```{r quiz_mean_eff}
quiz(
  question("Which treatment provides the best health outcomes (in terms of quality of life)?", 
           answer("Open transthoracic esophagectomy (usual care)"),
           answer("Robot-assisted surgery (new intervention)", correct = TRUE)),
  question("Is robot-assisted surgery an improvement upon usual care with respect to all outcomes displayed above? Select the outcomes for which open transthoracic esophagectomy (usual care) provides better results.",
           answer("OR time"),
           answer("Occurence of major complications"),
           answer("Occurence of minor complications", correct = TRUE),
           answer("Length of stay at the ICU"),
           answer("Length of stay at the MCU", correct = TRUE),
           answer("Occurence of death"),
           answer("Quality of life"),
           answer("None"),
           incorrect = "Too bad, this is not correct. The correct answers were: 'Occurence of minor complications' and Length of stay at the MCU', since robot-assisted surgery leads to more minor complications and longer length of stay at the MCU"
           )
)
```

### Assignment 2
Create three new variables in `df` called `Cost_procedure`, `Cost_compl`, `Cost_hosp`, which respectively contain the costs related to the procedure (operatime time + procedure), the costs related to complications, and the costs related to hospitalisation for each participant. To do so, use the objects beginning with `c_`. Create also a new variable in `df` called `Total_costs`, which contains the total costs per participant. Finally, calculate the mean costs per group.  

```{r calc_t_costs, exercise = TRUE}


```

```{r calc_t_costs-hint-1}
"To fill in the variables `Cost_procedure`, `Cost_compl`, `Cost_hosp`, multiply the column of the dataframe `df` by the corresponding objects. For `Cost_procedure`, the ifelse() function should be used to make a difference between the costs of open transthoracic esophagectomy and robot-assisted thoraco-laparoscopic esophagesctomy. For the `Total_costs`, the sum of the other columns should be calculated.  "
```

```{r calc_t_costs-hint-2}
# Example for calculating the new variable `Cost_procedure`
df$Cost_procedure <- ifelse(df$Procedure == 1, c_Open + df$OR_time * c_OK_hour, c_Robot + df$OR_time * c_OK_hour)
```

```{r calc_t_costs-solution}
# Creating new columns
df$Cost_procedure <- ifelse(df$Procedure == 1, c_Open + df$OR_time / 60 * c_OK_hour, c_Robot + df$OR_time / 60 * c_OK_hour) # cost procedure
df$Cost_compl <- df$Major_compl * c_Major_compl + df$Minor_compl * c_Minor_compl # costs complications
df$Cost_hosp  <- df$Length_icu * c_ICU_day + df$Length_mcu * c_MCU_day # costs hospitalisation
df$Total_costs <- df$Cost_procedure + df$Cost_compl + df$Cost_hosp
df %>% 
  group_by(Procedure) %>%
  summarise(Tot_costs = mean(Total_costs))


# Alternative tidyverse-style
df %>%
  summarise(Procedure = Procedure,
            Cost_procedure = ifelse(Procedure == 1, c_Open + OR_time / 60 * c_OK_hour, c_Robot + OR_time / 60 * c_OK_hour),
            Cost_compl = Major_compl * c_Major_compl + Minor_compl * c_Minor_compl,
            Cost_hosp = Length_icu * c_ICU_day + Length_mcu * c_MCU_day,
            Total_costs = Cost_procedure + Cost_compl + Cost_hosp) %>%
  group_by(Procedure) %>%
  summarise(Mean_total_costs = mean(Total_costs))
```

### Assignment 2 - questions
The correct results are displayed here below. You can check your answer based in these results and answer the questions of the quizz.

```{r calc_to_c_good}
df %>%
  summarise(Procedure = Procedure,
            Cost_procedure = ifelse(Procedure == 1, c_Open + OR_time / 60 * c_OK_hour, c_Robot + OR_time / 60 * c_OK_hour),
            Cost_compl = Major_compl * c_Major_compl + Minor_compl * c_Minor_compl,
            Cost_hosp = Length_icu * c_ICU_day + Length_mcu * c_MCU_day,
            Total_costs = Cost_procedure + Cost_compl + Cost_hosp) %>%
  group_by(Procedure) %>%
  summarise(Mean_cost_procedure = mean(Cost_procedure),
            Mean_cost_compl = mean(Cost_compl),
            Mean_cost_hosp = mean(Cost_hosp),
            Mean_total_costs = mean(Total_costs))
```

```{r quiz_tot_costs}
quiz(
  question("Which treatment is cheaper on average, given the observed trial data?", 
           answer("Open transthoracic esophagectomy (usual care)", correct = TRUE),
           answer("Robot-assisted surgery (new intervention)"),
           incorrect = "Too bad, this is incorrect. Open transthoracic esophagectomy is cheaper sinds the mean total costs of this procedure are lower than the mean total costs of the robot-assisted surgery procedure")
)
```

What do you think is the probability that the new intervention is cheaper?  

```{r open_q_1}
textInput("Answer_1", "Enter your answer")
```

What do you think is the probability that the new intervention leads to health gain?  

```{r open_q_2}
textInput("Answer_2", "Enter your answer")
```

### Assignment 3  
Calculate the difference in mean quality of life and mean total costs between the new intervention (robot-assisted) and usual care (open surgery) (i.e. the incremental effects and incremental costs). Calculate the ICER using this information. *Hint: use the results you obtained in previous steps*.   
5. Save your dataframe `df` as a .csv file. Ensure that your total effects per participants are in the `Qol` variable and the total costs in the `Total_costs` variable.  
6. Open the R shiny app using the following command in R and follow the instructions.  
